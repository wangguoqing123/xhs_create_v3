# 会员系统架构图

## 1. 会员系统总体架构

```mermaid
graph TB
    A[用户] --> B[管理员操作]
    B --> C{会员操作类型}
    
    C -->|设置月会员| D[SetMembership lite monthly]
    C -->|设置年会员| E[SetMembership pro yearly]
    C -->|取消会员| F[CancelMembership]
    C -->|赠送积分包| G[GrantCreditPackage]
    
    D --> H[会员等级检查]
    E --> H
    F --> I[状态变更为cancelled]
    G --> J[仅会员可获得积分包]
    
    H --> K{等级/时长是否变更?}
    K -->|仅等级变更| L[保持到期时间,调整积分下限]
    K -->|仅时长变更| M[重置到期时间,重置积分]  
    K -->|都变更| N[重置到期时间,重置积分]
    K -->|新用户| O[设置到期时间,给予初始积分]
    
    L --> P[更新memberships表]
    M --> P
    N --> P
    O --> P
    
    P --> Q[记录admin_operation_logs]
    I --> Q
    J --> Q
    
    style H fill:#e1f5fe
    style K fill:#fff3e0
    style P fill:#f3e5f5
```

## 2. 会员等级和权益体系

```mermaid
graph LR
    A[会员体系] --> B[Lite会员]
    A --> C[Pro会员] 
    A --> D[Premium会员]
    
    B --> B1[月度积分: 100]
    B --> B2[基础功能]
    B --> B3[月费: 低]
    
    C --> C1[月度积分: 250]
    C --> C2[高级功能]
    C --> C3[年费: 中]
    
    D --> D1[月度积分: 600]
    D --> D2[全部功能]
    D --> D3[年费: 高]
    
    B1 --> E[积分包资格]
    C1 --> E
    D1 --> E
    
    style B fill:#c8e6c9
    style C fill:#b3e5fc
    style D fill:#f8bbd9
```

## 3. 会员设置逻辑流程

```mermaid
graph TD
    A[管理员设置会员] --> B[验证管理员权限]
    B --> C[获取用户现有会员信息]
    C --> D{现有会员状态}
    
    D -->|无会员| E[新用户流程]
    D -->|有会员| F[会员变更流程]
    
    E --> G[设置新到期时间]
    G --> H[给予初始积分]
    H --> I[创建memberships记录]
    
    F --> J{变更类型判断}
    J -->|仅等级变更| K[保持到期时间]
    J -->|仅时长变更| L[重置到期时间]
    J -->|等级+时长变更| M[重置到期时间]
    
    K --> N[调整积分下限]
    L --> O[重置积分到新额度]
    M --> O
    
    I --> P[取消旧会员记录]
    N --> P
    O --> P
    
    P --> Q[记录操作日志]
    Q --> R[发送通知]
    
    style J fill:#fff3e0
    style N fill:#e8f5e8
    style O fill:#fff9c4
```

## 4. 会员积分重置机制

```mermaid
graph TB
    A[定时任务/用户操作触发] --> B[CheckAndResetUserCredits]
    B --> C[获取用户会员信息]
    C --> D{是否为活跃会员?}
    
    D -->|否| E[跳过重置]
    D -->|是| F[检查next_credits_reset时间]
    
    F --> G{是否到达重置时间?}
    G -->|否| H[无需重置]
    G -->|是| I[执行重置逻辑]
    
    I --> J[重置积分到monthly_credits]
    J --> K[更新last_credits_reset]
    K --> L[计算下次重置时间]
    L --> M[更新next_credits_reset]
    M --> N[记录交易日志]
    
    style D fill:#fff3e0
    style G fill:#fff3e0
    style I fill:#e8f5e8
```

## 5. 会员数据库设计

```mermaid
erDiagram
    memberships {
        string id PK "会员ID"
        string user_id FK "用户ID"
        string membership_level "会员等级"
        string membership_duration "会员时长"
        string status "会员状态"
        timestamp start_date "开始时间"
        timestamp end_date "到期时间"
        int monthly_credits "月度积分额度"
        timestamp last_credits_reset "上次积分重置时间"
        timestamp next_credits_reset "下次积分重置时间"
        boolean auto_renew "自动续费"
        timestamp created_at "创建时间"
        timestamp updated_at "更新时间"
    }
    
    credit_packages {
        string id PK "积分包ID"
        string user_id FK "用户ID"
        string package_type "积分包类型"
        int credits_amount "积分数量"
        string granted_by "赠送者"
        string reason "赠送原因"
        timestamp created_at "创建时间"
    }
    
    admin_operation_logs {
        string id PK "日志ID"
        string admin_user "管理员用户名"
        string operation_type "操作类型"
        string target_user_id FK "目标用户ID"
        string target_user_email "目标用户邮箱"
        json operation_details "操作详情"
        string ip_address "IP地址"
        timestamp created_at "创建时间"
    }
    
    users ||--o{ memberships : "一对多"
    users ||--o{ credit_packages : "一对多"
    users ||--o{ admin_operation_logs : "一对多"
```

## 6. 会员状态管理

```mermaid
stateDiagram-v2
    [*] --> NoMembership: 新用户
    NoMembership --> Active: 管理员设置会员
    Active --> Active: 等级调整
    Active --> Expired: 到期未续费
    Active --> Cancelled: 管理员取消
    Expired --> Active: 续费激活
    Cancelled --> Active: 重新激活
    
    Active : 享受会员权益
    Active : 月度积分重置
    Active : 可获得积分包
    
    Expired : 会员权益暂停
    Expired : 积分不再重置
    
    Cancelled : 会员权益终止
    Cancelled : 需重新设置
```

## 7. 年会员特殊积分发放

```mermaid
graph TB
    A[年会员积分发放定时任务] --> B[获取所有活跃年会员]
    B --> C[遍历年会员列表]
    C --> D{当月是否已发放?}
    
    D -->|是| E[跳过该用户]
    D -->|否| F[发放800积分]
    
    E --> G[处理下一用户]
    F --> H[记录yearly_member_credits]
    H --> I[创建交易记录]
    I --> G
    
    G --> J{是否还有用户?}
    J -->|是| C
    J -->|否| K[发放完成]
    
    style F fill:#c8e6c9
    style H fill:#f3e5f5
```

## 8. 管理员操作审计

```mermaid
graph LR
    A[管理员操作] --> B[身份验证]
    B --> C[权限检查]
    C --> D[执行操作]
    D --> E[记录操作日志]
    
    E --> F[IP地址记录]
    E --> G[用户代理记录]
    E --> H[操作详情JSON]
    E --> I[时间戳]
    
    F --> J[admin_operation_logs表]
    G --> J
    H --> J
    I --> J
    
    J --> K[审计报告]
    J --> L[异常监控]
    
    style E fill:#fff3e0
    style J fill:#f3e5f5
```

## 关键代码路径

### 会员设置关键函数
- `SetMembership` 存储过程 in 015_improve_membership_logic.sql:20
- `AdminSetMembership()` in lib/mysql.ts
- `/api/admin/operations/set-membership/route.ts`

### 会员状态查询
- `getUserMembershipStatus()` in lib/mysql.ts:1931
- `user_membership_status` 视图
- `/api/membership/status/route.ts`

### 积分重置机制
- `CheckAndResetUserCredits` 存储过程
- `checkAndResetUserCredits()` in lib/mysql.ts
- `/api/credits/check-reset/route.ts`