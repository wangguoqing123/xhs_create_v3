# 实现计划

- [x] 1. 数据库迁移和结构更新
  - 创建数据库迁移脚本，更新 admin_operation_logs 表的 operation_type 枚举，添加 'adjust_membership_expiry' 类型
  - 验证现有的 memberships 表结构是否支持所需操作
  - _需求: 需求4.2, 需求4.3_

- [x] 2. 后端 API 实现
  - [x] 2.1 创建调整会员到期时间的 API 路由
    - 在 `/app/api/admin/operations/adjust-membership-expiry/route.ts` 创建 POST 端点
    - 实现请求参数验证（user_id, new_expiry_date, reason）
    - 实现日期格式验证和业务逻辑检查
    - _需求: 需求1.3, 需求1.4, 需求3.2_

  - [x] 2.2 实现数据库操作函数
    - 在 `lib/mysql.ts` 中添加 `adminAdjustMembershipExpiry` 函数
    - 实现获取当前会员信息的查询
    - 实现更新会员到期时间的操作
    - 实现管理员操作日志记录
    - _需求: 需求1.4, 需求1.5, 需求4.1, 需求4.2_

  - [x] 2.3 添加错误处理和响应格式
    - 实现参数验证错误处理
    - 实现数据库操作错误处理
    - 确保响应格式与现有 API 保持一致
    - _需求: 需求3.2, 需求3.3, 需求3.5_

- [x] 3. 前端界面实现
  - [x] 3.1 添加调整到期时间按钮
    - 在管理员页面的用户搜索结果中添加"调整到期时间"按钮
    - 使用 Clock 图标，保持与现有按钮样式一致
    - 实现按钮点击事件处理
    - _需求: 需求1.1, 需求2.1_

  - [x] 3.2 创建调整到期时间模态框组件
    - 创建模态框显示当前会员状态和到期时间
    - 添加日期时间选择器（使用 datetime-local 输入类型）
    - 添加原因输入字段
    - 实现表单验证和提交逻辑
    - _需求: 需求1.2, 需求2.2, 需求2.3_

  - [x] 3.3 集成模态框到管理员页面
    - 在 `app/admin/page.tsx` 中添加模态框状态管理
    - 实现打开/关闭模态框的函数
    - 添加表单数据状态管理
    - _需求: 需求1.1, 需求1.2_

- [ ] 4. API 调用和状态管理
  - [x] 4.1 实现前端 API 调用函数
    - 创建调用调整到期时间 API 的函数
    - 实现加载状态管理
    - 实现成功/失败消息处理
    - _需求: 需求1.6, 需求3.4_

  - [x] 4.2 实现界面刷新机制
    - 成功调整后刷新用户搜索结果
    - 更新用户列表中的会员状态显示
    - 实现乐观更新或重新获取数据
    - _需求: 需求3.4, 需求1.6_

- [ ] 5. 用户体验优化
  - [ ] 5.1 改进会员状态显示
    - 在用户列表中清晰显示会员状态（活跃/已过期）
    - 显示会员等级和到期时间
    - 对无会员用户显示"无会员"状态
    - _需求: 需求2.1, 需求2.2, 需求2.3, 需求2.4_

  - [ ] 5.2 添加加载状态和用户反馈
    - 在模态框中添加提交时的加载指示器
    - 实现防止重复提交的机制
    - 添加成功/失败的消息提示
    - _需求: 需求1.6, 需求3.3_

- [ ] 6. 测试和验证
  - [ ] 6.1 创建单元测试
    - 为 API 路由创建测试用例
    - 测试正常流程和错误处理
    - 测试数据库操作函数
    - _需求: 需求1.3, 需求1.4, 需求3.2_

  - [ ] 6.2 进行集成测试
    - 测试完整的用户操作流程
    - 验证数据库更新和日志记录
    - 测试边界条件（过去日期、无效格式等）
    - _需求: 需求3.1, 需求3.2, 需求4.1_

- [ ] 7. 文档和部署准备
  - [ ] 7.1 更新相关文档
    - 更新 API 文档说明新的端点
    - 更新管理员操作手册
    - 记录新增的数据库字段和操作类型
    - _需求: 需求4.3, 需求4.5_

  - [ ] 7.2 验证功能完整性
    - 确认所有需求都已实现
    - 验证与现有系统的兼容性
    - 进行最终的功能测试
    - _需求: 需求1.1-1.6, 需求2.1-2.4, 需求3.1-3.5, 需求4.1-4.5_