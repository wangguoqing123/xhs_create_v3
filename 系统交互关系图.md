# 积分系统与会员系统交互关系图

## 1. 系统整体交互架构

```mermaid
graph TB
    subgraph "前端系统"
        A[用户界面] --> B[CreditsContext]
        A --> C[MembershipInfo]
        B --> D[积分显示组件]
        C --> E[会员状态组件]
    end
    
    subgraph "API层"
        F[/api/credits/*] --> G[积分相关API]
        H[/api/membership/*] --> I[会员相关API]
        J[/api/admin/*] --> K[管理后台API]
    end
    
    subgraph "业务逻辑层"
        L[lib/mysql.ts] --> M[积分操作函数]
        L --> N[会员操作函数]
        L --> O[数据库连接管理]
    end
    
    subgraph "数据库层"
        P[(profiles表)] --> Q[用户积分存储]
        R[(memberships表)] --> S[会员信息存储]
        T[(credit_transactions表)] --> U[积分交易记录]
        V[(admin_operation_logs表)] --> W[管理操作审计]
    end
    
    subgraph "存储过程层"
        X[ConsumeCredits] --> Y[积分扣除逻辑]
        Z[SetMembership] --> AA[会员设置逻辑]
        BB[GrantCredits] --> CC[积分赠送逻辑]
        DD[CheckAndResetUserCredits] --> EE[积分重置逻辑]
    end
    
    A --> F
    A --> H
    A --> J
    
    G --> M
    I --> N
    K --> N
    K --> M
    
    M --> X
    M --> BB
    M --> DD
    N --> Z
    
    Y --> P
    Y --> T
    CC --> P
    CC --> T
    EE --> P
    EE --> R
    AA --> R
    AA --> P
    AA --> V
    
    style A fill:#e3f2fd
    style L fill:#f3e5f5
    style P fill:#e8f5e8
    style X fill:#fff3e0
```

## 2. 积分与会员权益联动机制

```mermaid
graph TD
    A[用户操作] --> B{操作类型}
    
    B -->|消费功能| C[检查积分余额]
    B -->|成为会员| D[检查会员权益]
    B -->|积分重置| E[检查会员状态]
    
    C --> F{积分足够?}
    F -->|是| G[扣除积分执行功能]
    F -->|否| H[检查会员等级]
    
    H --> I{会员积分额度}
    I -->|有额度| J[使用会员积分]
    I -->|无额度| K[提示充值或升级]
    
    D --> L[设置会员等级]
    L --> M[分配月度积分]
    M --> N[设置积分重置周期]
    
    E --> O{会员是否有效?}
    O -->|是| P[重置到会员积分额度]
    O -->|否| Q[保持当前积分]
    
    G --> R[更新积分余额]
    J --> R
    P --> R
    
    style F fill:#fff3e0
    style I fill:#fff3e0
    style O fill:#fff3e0
```

## 3. 数据流转关系

```mermaid
graph LR
    subgraph "用户数据中心"
        A[users表] --> B[profiles表]
        A --> C[memberships表]
    end
    
    subgraph "交易记录中心"
        D[credit_transactions表]
        E[credit_packages表]
        F[yearly_member_credits表]
    end
    
    subgraph "管理审计中心"
        G[admin_operation_logs表]
    end
    
    subgraph "视图聚合层"
        H[user_membership_status视图]
    end
    
    B --> D
    C --> E
    C --> F
    A --> G
    
    A --> H
    B --> H
    C --> H
    
    H --> I[管理后台显示]
    H --> J[前端状态查询]
    
    style H fill:#e1f5fe
    style I fill:#f8bbd9
    style J fill:#c8e6c9
```

## 4. 关键业务流程交互

```mermaid
sequenceDiagram
    participant User as 用户
    participant Frontend as 前端
    participant API as API层
    participant MySQL as 数据库
    participant SP as 存储过程
    
    Note over User,SP: 用户消费功能场景
    
    User->>Frontend: 点击使用功能
    Frontend->>API: POST /api/rewrite
    API->>MySQL: getProfile(userId)
    MySQL-->>API: 返回用户积分
    
    API->>SP: CALL ConsumeCredits(userId, 1, reason)
    SP->>MySQL: 检查积分余额
    SP->>MySQL: 扣除积分
    SP->>MySQL: 记录交易
    SP-->>API: 返回扣除结果
    
    alt 功能执行成功
        API->>User: 返回生成结果
        API->>Frontend: 发送积分更新通知
    else 功能执行失败
        API->>SP: CALL RefundCredits(userId, 1, reason)
        SP->>MySQL: 退还积分
        SP->>MySQL: 记录退款交易
        API->>User: 返回错误信息
    end
    
    Frontend->>API: 刷新积分显示
    API->>MySQL: 获取最新积分
    MySQL-->>Frontend: 更新积分显示
```

## 5. 会员权益与积分额度关系

```mermaid
graph TB
    A[会员体系] --> B{会员等级}
    
    B -->|Lite会员| C[月度100积分]
    B -->|Pro会员| D[月度250积分]
    B -->|Premium会员| E[月度600积分]
    B -->|非会员| F[固定积分池]
    
    C --> G[可获得积分包]
    D --> G
    E --> G
    F --> H[仅消费现有积分]
    
    G --> I[额外积分奖励]
    I --> J[更多功能使用次数]
    H --> K[基础功能使用]
    
    subgraph "积分重置机制"
        L[每月1号] --> M{会员状态检查}
        M -->|活跃会员| N[重置到月度额度]
        M -->|非会员| O[不进行重置]
    end
    
    C --> L
    D --> L
    E --> L
    
    style G fill:#c8e6c9
    style I fill:#f8bbd9
    style N fill:#fff9c4
```

## 6. 系统监控与预警机制

```mermaid
graph TD
    A[系统监控中心] --> B[积分一致性监控]
    A --> C[会员状态监控]
    A --> D[交易异常监控]
    A --> E[管理操作审计]
    
    B --> F[profiles vs view对比]
    B --> G[定期CheckCreditsSync]
    
    C --> H[到期会员检测]
    C --> I[积分重置异常]
    
    D --> J[大额积分变动]
    D --> K[频繁退款操作]
    
    E --> L[管理员操作日志]
    E --> M[权限异常检测]
    
    F --> N{发现不一致?}
    G --> N
    H --> O{需要处理?}
    I --> O
    J --> P{需要预警?}
    K --> P
    L --> Q{异常操作?}
    M --> Q
    
    N -->|是| R[发送修复通知]
    O -->|是| S[发送业务通知]
    P -->|是| T[发送安全预警]
    Q -->|是| U[发送管理预警]
    
    style N fill:#fff3e0
    style O fill:#fff3e0
    style P fill:#ffebee
    style Q fill:#ffebee
```

## 7. 跨窗口数据同步机制

```mermaid
graph TB
    A[用户操作窗口A] --> B[积分变更]
    B --> C[更新localStorage缓存]
    C --> D[发送BroadcastChannel消息]
    D --> E[发送PostMessage消息]
    
    F[用户窗口B] --> G[监听storage事件]
    F --> H[监听BroadcastChannel]
    F --> I[监听PostMessage]
    
    G --> J[检测缓存变化]
    H --> K[接收实时消息]
    I --> K
    
    J --> L[更新前端显示]
    K --> L
    
    L --> M[刷新积分组件]
    M --> N[刷新会员状态]
    
    subgraph "页面可见性检测"
        O[页面重新激活] --> P[检查数据时效性]
        P --> Q{超过2分钟?}
        Q -->|是| R[强制刷新数据]
        Q -->|否| S[使用缓存数据]
    end
    
    R --> L
    
    style D fill:#e1f5fe
    style K fill:#c8e6c9
    style R fill:#fff9c4
```

## 关键技术实现点

### 数据一致性保障
- 数据库事务确保ACID特性
- 存储过程封装复杂业务逻辑
- 定期数据一致性检查

### 前端状态管理
- React Context统一积分状态
- 5分钟缓存策略减少API调用
- 跨窗口实时同步机制

### 安全性保障
- JWT身份验证
- 管理员操作审计日志
- IP地址和User-Agent记录

### 性能优化
- 连接池管理数据库连接
- 视图优化查询性能  
- 缓存策略减少数据库压力