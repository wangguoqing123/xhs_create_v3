# 封面批量更新功能指南

> 📝 **注意**: 主要文档已迁移到 [README.md](./README.md)，本文档仅保留封面更新的详细操作步骤。

## 功能概述

这个功能可以批量更新爆款内容的封面图片，通过小红书链接自动获取最新的封面图片。

## 使用步骤

### 1. 访问管理员页面
- 打开管理员页面：`/admin`
- 在"爆款内容管理"部分找到"封面更新"按钮
- 点击按钮会在新标签页中打开封面更新页面

### 2. 配置更新参数
- **小红书Cookie**：必填项，用于访问小红书API
- **批处理数量**：每次处理的数量，建议50-100个
- **测试模式**：勾选后只会模拟更新，不会实际修改数据库

### 3. 查看待更新内容
- 页面会自动加载需要更新封面的内容列表
- 显示当前封面状态、标题、作者等信息
- 可以点击源链接查看原始小红书笔记

### 4. 执行批量更新
- 确保已输入有效的小红书Cookie
- 点击"开始更新"按钮
- 系统会显示实时进度和处理结果

## 更新逻辑

### 筛选条件
系统会自动筛选需要更新封面的内容：
- 封面图片为空（NULL）
- 封面图片为空字符串
- 封面图片为默认占位图（/placeholder.jpg）
- 封面图片包含"placeholder"关键词
- 必须有有效的小红书源链接

### 更新流程
1. 从数据库获取待更新的内容列表
2. 遍历每个内容的源链接
3. 调用小红书API获取笔记详情
4. 提取第一张图片作为封面
5. 更新数据库中的cover_image字段
6. 记录处理结果和日志

### 错误处理
- 无效的小红书链接会被跳过
- API调用失败会记录错误信息
- 数据库更新失败会回滚操作
- 每个请求间隔1秒避免频率限制

## 注意事项

### 1. Cookie配置
- 需要有效的小红书Cookie才能访问API
- Cookie过期会导致所有请求失败
- 建议使用最新的Cookie字符串

### 2. 处理频率
- 系统会自动添加1秒延迟避免请求过频
- 建议分批处理，每次50-100个内容
- 避免在高峰期进行大量更新

### 3. 测试模式
- 首次使用建议开启测试模式
- 测试模式会模拟整个流程但不更新数据库
- 可以验证Cookie有效性和链接可用性

### 4. 结果验证
- 更新完成后会显示详细的处理结果
- 成功的更新会显示新的封面URL
- 失败的更新会显示具体错误信息

## 技术实现

### API接口
- `GET /api/admin/explosive-contents/batch-update-covers` - 获取待更新内容
- `POST /api/admin/explosive-contents/batch-update-covers` - 执行批量更新

### 数据库函数
- `getExplosiveContentsNeedCoverUpdate()` - 获取需要更新的内容
- `updateExplosiveContentCover()` - 更新单个内容的封面
- `createCoverUpdateLog()` - 记录更新日志

### 前端页面
- `/admin/cover-update` - 封面更新管理页面
- 实时进度显示
- 结果统计和详情展示

## 故障排除

### 1. Cookie无效
- 错误：认证失败或403错误
- 解决：更新小红书Cookie字符串

### 2. 链接失效
- 错误：无法获取笔记详情
- 解决：检查源链接是否有效

### 3. 数据库连接失败
- 错误：MySQL连接错误
- 解决：检查数据库配置和连接状态

### 4. 权限不足
- 错误：未授权访问
- 解决：确保以管理员身份登录

## 最佳实践

1. **分批处理**：每次处理50-100个内容，避免超时
2. **测试先行**：首次使用时开启测试模式验证
3. **定期更新**：建议每周执行一次封面更新
4. **监控结果**：关注失败率，及时处理异常情况
5. **备份数据**：重要操作前备份数据库

## 更新日志

### v1.0.0 (2024-01-XX)
- 初始版本发布
- 支持批量更新封面功能
- 添加测试模式和进度显示
- 完整的错误处理和日志记录 