# 积分系统架构图

## 1. 积分系统总体架构

```mermaid
graph TB
    A[用户] --> B[前端界面]
    B --> C{用户操作}
    
    C -->|注册| D[获得初始积分20]
    C -->|消费功能| E[积分扣除]
    C -->|成为会员| F[获得会员积分]
    C -->|管理员赠送| G[管理员操作]
    
    D --> H[profiles表]
    E --> I{积分充足?}
    I -->|是| J[扣除积分]
    I -->|否| K[返回错误]
    
    J --> L[执行功能]
    L -->|成功| M[记录交易]
    L -->|失败| N[退还积分]
    
    F --> O[会员积分发放]
    G --> P[直接增加积分]
    
    M --> H
    N --> H
    O --> H
    P --> H
    
    H --> Q[credit_transactions]
    
    style H fill:#e1f5fe
    style Q fill:#f3e5f5
    style I fill:#fff3e0
```

## 2. 积分获取流程

```mermaid
graph LR
    A[积分获取触发点] --> B{获取类型}
    
    B -->|新用户注册| C[赠送20积分]
    B -->|成为月会员| D[赠送500积分]
    B -->|成为年会员| E[赠送800积分]
    B -->|月度重置| F[重置到会员等级额度]
    B -->|管理员赠送| G[自定义积分数量]
    B -->|积分包| H[大额积分包]
    
    C --> I[创建交易记录reward]
    D --> I
    E --> I
    F --> I
    G --> I
    H --> I
    
    I --> J[更新profiles.credits]
    J --> K[发送通知更新前端]
    
    style C fill:#c8e6c9
    style D fill:#c8e6c9
    style E fill:#c8e6c9
    style F fill:#fff9c4
    style G fill:#f8bbd9
    style H fill:#f8bbd9
```

## 3. 积分消费流程

```mermaid
graph TD
    A[用户发起消费操作] --> B[验证用户身份]
    B --> C[获取用户当前积分]
    C --> D{积分是否足够?}
    
    D -->|否| E[返回积分不足错误]
    D -->|是| F[调用ConsumeCredits存储过程]
    
    F --> G[开始数据库事务]
    G --> H[扣除积分]
    H --> I[创建consume交易记录]
    I --> J[提交事务]
    
    J --> K[执行实际功能]
    K --> L{功能执行结果}
    
    L -->|成功| M[操作完成]
    L -->|失败| N[调用RefundCredits]
    
    N --> O[创建refund交易记录]
    O --> P[恢复积分]
    P --> M
    
    M --> Q[更新前端积分显示]
    
    style D fill:#fff3e0
    style K fill:#fff3e0
    style E fill:#ffebee
    style N fill:#e8f5e8
```

## 4. 积分交易记录结构

```mermaid
erDiagram
    credit_transactions {
        string id PK "交易ID"
        string user_id FK "用户ID"
        string transaction_type "交易类型"
        int amount "积分数量"
        string reason "交易原因"
        string related_task_id "关联任务ID"
        timestamp created_at "创建时间"
    }
    
    profiles {
        string id PK "用户ID"
        string email "邮箱"
        int credits "当前积分"
        timestamp updated_at "更新时间"
    }
    
    profiles ||--o{ credit_transactions : "一对多"
```

## 5. 积分一致性保障机制

```mermaid
graph TB
    A[积分操作请求] --> B[获取数据库连接]
    B --> C[开始事务]
    C --> D[执行积分操作]
    D --> E[记录交易日志]
    E --> F{操作是否成功?}
    
    F -->|是| G[提交事务]
    F -->|否| H[回滚事务]
    
    G --> I[更新缓存]
    H --> J[返回错误]
    
    I --> K[发送跨窗口更新消息]
    K --> L[更新前端显示]
    
    style C fill:#e3f2fd
    style G fill:#e8f5e8
    style H fill:#ffebee
```

## 6. 积分系统监控点

```mermaid
graph LR
    A[积分系统监控] --> B[数据一致性检查]
    A --> C[交易记录审计]
    A --> D[异常操作监控]
    
    B --> E[CheckCreditsSync存储过程]
    B --> F[profiles vs view对比]
    
    C --> G[交易类型统计]
    C --> H[大额交易监控]
    
    D --> I[频繁操作检测]
    D --> J[异常退款监控]
    
    style B fill:#e1f5fe
    style C fill:#f3e5f5
    style D fill:#fff3e0
```

## 关键代码路径

### 积分扣除关键函数
- `consumeCredits()` in lib/mysql.ts:1234
- `ConsumeCredits` 存储过程 in 001_create_database_schema.sql:279

### 积分查询关键函数  
- `getProfile()` in lib/mysql.ts
- `/api/credits/balance/route.ts` API端点

### 前端积分管理
- `CreditsContext` in components/credits-context.tsx
- 跨窗口同步机制
- 缓存策略（5分钟TTL）